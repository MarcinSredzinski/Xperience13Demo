@using CMS.CustomTables;
@using CMS.DataEngine;
@using CMS.EventLog;
@using DemoDomainObjects.Models.WeatherStack;
@using Kentico.PageBuilder.Web.Mvc;
@using BestPDemoSite.Components.PageBuilder.Widgets.HelloWidget;
@using System.Net.Http;
@using System.Net.Http.Json;


@model ComponentViewModel<HelloWidgetProperties>

@{
    string customTableClassName = "demo.CityName";
    DataClassInfo customTable = DataClassInfoProvider.GetDataClassInfo(customTableClassName);
    string temperatureForCities = "";
    var cityNames = CustomTableItemProvider.GetItems<CMS.CustomTables.Types.Demo.CityNameItem>()
                                                     .Columns("CityName").Select(c => c.CityName).ToList();
   
}

@Model.Properties.WelcomeText
<br />

@foreach (string city in cityNames)
{
    var httpClient = new HttpClient();
    var baseAddress = SettingsKeyInfoProvider.GetValue("WeatherstackApiBaseUrl");
    var apiKey = SettingsKeyInfoProvider.GetValue("WeatherstackApiKey");
    httpClient.BaseAddress = new Uri("http://api.weatherstack.com/");
    var response = await httpClient.GetAsync(($"current?access_key={apiKey}&query={city}"));
    var weather = await response.Content.ReadFromJsonAsync<WeatherForecast>();
    EventLogProvider.LogInformation("HelloWidget", "WeatherForecast", "Weather forecast downloaded");
    temperatureForCities += $"Temperature for: {city} is {weather?.Current?.Temperature} <br />";
}

@Html.Raw(temperatureForCities)